
# 准备工作

安装 Python3, 目前最新版本是 3.6.2, 下载地址 https://www.python.org/downloads/ .

注意区分操作系统位数, 32位选择"x86", 64位选择"x86-64""AMD64". 记得勾选添加到环境变量. 

打开命令提示符运行`python --version`检查是否安装成功. 

安装 pywin32, 地址 https://sourceforge.net/projects/pywin32/files/pywin32/ .

同样注意区分操作系统位数, 以及对应的 Python 版本号. 

比如已经安装的Python版本是64位的3.6.2, 需要下载的文件则是`pywin32-221.win-amd64-py3.6.exe`. 

打开命令提示符运行`pip list`后能看到`pywin32`就说明安装成功了. 

下载 [pvz.py](https://github.com/lmintlcx/pvz.py) 和自己编写的脚本放在同一文件夹下. 

编写代码最好是用专业的文本编辑器, 推荐 Notepad++ / Sublime Text / VS Code. 语法高亮和自动补全功能都很好用哒. 不推荐记事本(换行, BOM头等问题). 

还需要了解一点 Python 语言基础. 这个网站虽说不怎么专业但是作为入门教程来说足够用了, [Python 3 教程](http://www.runoob.com/python3/python3-tutorial.html) .

主要包括: .py文件的运行, 注释, 导入模块(import语句), 代码块的缩进, 输出(print函数), 常用数据类型(数字/字符串/列表/元组), 运算符(算术/比较/赋值/逻辑), 条件控制(if语句), 循环(for语句/range函数/pass语句), 函数的定义与调用, 函数参数, 变量作用域. 



# 内置函数

pvz.py 封装了一些基础的函数. 

`sleep(x)`

在x秒后进行下一个操作. 


`pvz.ChooseCard(行, 列, 是否是模仿者)`

在选卡页面选卡. 第三个参数可以省略, 默认为不是. 

pvz.ChooseCard(2, 7) # 寒冰菇

pvz.ChooseCard(2, 7, True) # 模仿者寒冰菇


`pvz.LetsRock()`

点击"Let's Rock"按钮. 


`pvz.preJudge(预判时间, 是否是大波)`

针对该波次的操作在刷新前多久进行, 单位cs. 第二个参数可以省略, 默认为不是. 

是否属于大波可用表达式"(wave%10 == 0)"来判断, 当wave的值为10/20的时候结果为True. 

pvz.preJudge(95) # 常用预判0.95秒

pvz.preJudge(55, True) # 第10/20波(僵尸出生点靠右)预判时间

pvz.preJudge(150, True) # 第20波可以炮炸珊瑚的预判时间


`pvz.Card(n)`

(在10格卡槽的情况下)选择卡槽中的第n张卡片.

pvz.Card(12) # 选择铲子


`pvz.Pnt((行, 列))`

点击地图上的该行该列中心点, 行和列可以不是整数. 

pvz.Pnt((6, 9)) # 点击6路9列


`pvz.Pao(行, 列)`

在pvz.paoList中按顺序选择一门炮, 然后点击地图上的该行该列中心点. 行和列可以不是整数. 

Pao(2, 9) # 炮击2路9列


`pvz.wave20()`

当拥有9门以上炮时闭着眼睛过20波的方法. 



# 编写脚本


新建脚本文件`xxx.py`, 和`pvz.py`放在同一文件夹. `xxx.py`内容如下. 

声明文字编码, 在脚本用汉字时必备. 

载入所需要的模块(即同一文件夹下的pvz.py). 

添加`from pvz import *`这句之后能够省略大部分`pvz.xxxxx`的前半部分. 

标明场地`pvz.scene`, 可选值"DE""NE""PE""FE""RE""ME", 默认"PE". 

标明场上所有炮的位置`pvz.paoList`, 以后轮坐标为准. 

接下来定义几个可能会用到的函数, 比如
"在选卡界面选十张卡"
"释放樱桃"
"释放核蘑菇"
"在某行某列释放原版冰"
"在某行某列释放复制冰"
"补坚果/南瓜"
"每50.1s存两个冰"
"点冰"
"中三路种垫材垫MJ"
"铲垫材"
"吹风扇"
"吃墓碑"
等等等等......

声明一个main()函数, 这个函数是必须的. 

打印当前获取的句柄窗口标题, 等待4s后选卡`ChoosingCard()`, 然后点击"Let's Rock!"按钮. 

**在调试脚本的时候可以把选卡函数注释掉, 手工选卡进入游戏场景然后退回主界面, 找到存档位置设置存档只读. 这样每次调试的时候是直接从选完卡后开始, 省去重新选卡和切换画面的时间.**

在合适的地方插入存冰(或者其他)线程. 

(通常情况下在命令提示符界面按`Ctrl+C`可以结束代码运行, 但是如果没有给子线程设置daemon=True的话按这个快捷键是不能在子线程还在运行的时候终止整个程序的, 这个时候直接去任务管理器里找到Python.exe进程杀掉吧.)

写一个主线程循环, wave值遍历1~20, 对应每次选卡共20波僵尸的处理. 

循环中对于每一波的处理分为几个部分, 先是设定预判时间, 然后是主要操作, 最后是设置延时保证能执行到该波次刷新以后. 

常用预判时间95cs. 第10波僵尸出生点偏右因此推迟到55cs. 第20波预判150cs可炮炸珊瑚. 

**然后根据wave值编写针对每一波的操作(这里重点).**

第10波额外加个樱桃消除延迟, 第20波预判1.5s炮炸珊瑚, 等待0.9s后再炸前场. 

第9/19波打完炮后还需要额外用炮收尾, 所以要在对应波次的地方把pvz.nowPao变量加上额外需要的炮数, 让第10/20波自动选择的炮位相应地延后. 一般第9波打完两炮后还需要至少4门炮(加上冰瓜IO), 第9波打完两炮后还需要2门炮(自然出怪下). 

每一波操作都要运行到本波刷新以后, 除第20波外通常用的是0.95s和0.55s预判. 所以每波至少要延迟0.95s来保证本次循环执行到本波刷新以后再执行下一个循环. 

至此main()函数就写完了. 具体细节看代码. 



# 代码示例

给出几个例子, 按顺序由浅入深. 具体细节看代码及其注释. 

PE经典十炮
节奏 P6: PP|PP|PP|PP|PP|N
视频 https://www.bilibili.com/video/av14875298/

PE前置八炮
节奏 ch6: PP|I-PP|PP|I-PP, (6|12|6|12)
视频 https://www.bilibili.com/video/av14880401/

PE卖萌六炮
节奏 ch5: PP|I-PP|I-PP, (6|15|15)
视频 https://www.bilibili.com/video/av14888150/

PE双冰十六炮
节奏 ch6: PPDD|IPP-PP|PPDD|IPP-PP, (6|12|6|12)
视频 https://www.bilibili.com/video/av14877298/

PE拦截二十炮
节奏 ch6: PPSDD|IPP-PPD|PPSDD|IPP-PPD, (6|12|6|12)
视频 https://www.bilibili.com/video/av14881393/

NE前置八炮
节奏 C7u-56s: PP|I-PP|IPP-PP|PP|cccPP, (6|15|20|6|9)
视频 https://www.bilibili.com/video/av14611760/

FE无冰瓜十八炮
节奏 ch9-56s: PPDD|IPP-PP|PPDD|IPP-PP|PPDD|PPDD|PPN, (6|13|6|13|6|6|6)
视频 https://www.bilibili.com/video/av14889388/



# 使用方法

把写好的脚本`xxx.py`和`pvz.py`放在同一文件夹下. 

按Shift同时右键, 点击"在此处打开命令窗口", 输入`python xxx.py`. 

把鼠标光标移动到游戏窗口上, 按回车执行刚刚输入的命令. 

**注意只是把鼠标移到游戏窗口上, 不要点击, 此时焦点仍然在命令提示符窗口上. 回车执行命令后再点游戏.**



参考资料: 

https://tieba.baidu.com/p/4997515699
